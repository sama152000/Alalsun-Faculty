<section class="dashboard-content">
  <div class="management-header">
    <h2>Edit Department</h2>
  </div>
  <form [formGroup]="departmentForm" (ngSubmit)="saveDepartment()">
    <div class="tabs">
      <div class="tab-headers">
        <button type="button" class="tab-header" [class.active]="activeTab === 'basic'" (click)="activeTab = 'basic'">
          <i class="pi pi-info-circle"></i> Basic Info
        </button>
        <button type="button" class="tab-header" [class.active]="activeTab === 'programs'" (click)="activeTab = 'programs'">
          <i class="pi pi-graduation-cap"></i> Programs
        </button>
        <button type="button" class="tab-header" [class.active]="activeTab === 'faculty'" (click)="activeTab = 'faculty'">
          <i class="pi pi-users"></i> Faculty
        </button>
        <button type="button" class="tab-header" [class.active]="activeTab === 'activities'" (click)="activeTab = 'activities'">
          <i class="pi pi-calendar"></i> Activities
        </button>
        <button type="button" class="tab-header" [class.active]="activeTab === 'contact'" (click)="activeTab = 'contact'">
          <i class="pi pi-phone"></i> Contact
        </button>
      </div>
      <div class="tab-content" [class.active]="activeTab === 'basic'">
        <div class="form-grid">
          <div class="form-group">
            <label>Department Name *</label>
            <input 
              type="text" 
              class="form-control" 
              formControlName="name"
              placeholder="Enter department name"
            >
          </div>
          <div class="form-group">
            <label>Short Name *</label>
            <input 
              type="text" 
              class="form-control" 
              formControlName="shortName"
              placeholder="Enter short name"
            >
          </div>
          <div class="form-group full-width">
            <label>Overview *</label>
            <textarea 
              class="form-control" 
              formControlName="overview"
              rows="4"
              placeholder="Enter department overview"
            ></textarea>
          </div>
          <div class="form-group">
            <label>Type</label>
            <select formControlName="type" class="form-control">
              <option value="">Select type</option>
              <option *ngFor="let type of departmentTypes" [value]="type.value">
                {{ type.label }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label>Established Year</label>
            <input 
              type="text" 
              class="form-control" 
              formControlName="established"
              placeholder="e.g., 2016"
            >
          </div>
          <div class="form-group">
            <label>Department Image *</label>
            <div class="image-preview-section">
              <div class="current-image-preview">
                <img 
                  [src]="departmentForm.get('image')?.value || 'https://via.placeholder.com/150'" 
                  alt="Department Image" 
                  class="current-image"
                >
              </div>
              <div class="image-selection-section">
                <div class="upload-option">
                  <input type="file" #departmentImageInput (change)="onImageFileSelected($event, 'departmentImage')" 
                         accept="image/*" style="display: none;">
                  <button class="upload-btn" (click)="departmentImageInput.click()">
                    <i class="pi pi-upload"></i>
                    <span>Upload New Image</span>
                  </button>
                </div>
                <div class="media-gallery-section">
                  <button class="btn btn-outline-primary" (click)="openImageModal('departmentImage')">
                    <i class="pi pi-image me-2"></i>
                    Choose from Media Gallery
                  </button>
                  <div class="media-grid-small" *ngIf="imageMediaItems.length > 0">
                    <div class="media-item-small" 
                         *ngFor="let item of imageMediaItems | slice:0:4"
                         [class.selected]="departmentForm.get('image')?.value === item.url"
                         (click)="departmentForm.get('image')?.setValue(item.url)">
                      <img [src]="item.url" [alt]="item.name" class="media-thumb">
                      <div class="selection-overlay" *ngIf="departmentForm.get('image')?.value === item.url">
                        <i class="pi pi-check"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Icon Class</label>
            <input 
              type="text" 
              class="form-control" 
              formControlName="icon"
              placeholder="e.g., pi pi-book"
            >
          </div>
          <div class="form-group">
            <label>Route</label>
            <input 
              type="text" 
              class="form-control" 
              formControlName="route"
              placeholder="e.g., /departments/english"
            >
          </div>
        </div>
      </div>

      <div class="tab-content" [class.active]="activeTab === 'programs'">
        <div class="programs-section">
          <div class="section-header">
            <h4>Department Programs</h4>
            <button 
              type="button"
              class="btn-add-item"
              (click)="addProgram()"
            >
              <i class="pi pi-plus"></i>
              Add Program
            </button>
          </div>
          <div formArrayName="programs">
            <div 
              *ngFor="let program of programsArray.controls; let i = index"
              [formGroupName]="i"
              class="program-item"
            >
              <div class="item-header">
                <h5>Program {{ i + 1 }}</h5>
                <button 
                  type="button"
                  class="btn-remove"
                  (click)="removeProgram(i)"
                >
                  <i class="pi pi-trash"></i>
                </button>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label>Program Name *</label>
                  <input type="text" class="form-control" formControlName="name">
                </div>
                <div class="form-group">
                  <label>Duration</label>
                  <input type="text" class="form-control" formControlName="duration">
                </div>
                <div class="form-group">
                  <label>Degree</label>
                  <input type="text" class="form-control" formControlName="degree">
                </div>
                <div class="form-group full-width">
                  <label>Description</label>
                  <textarea class="form-control" formControlName="description" rows="3"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" [class.active]="activeTab === 'faculty'">
        <div class="faculty-section">
          <div class="section-header">
            <h4>Faculty Members</h4>
            <button 
              type="button"
              class="btn-add-item"
              (click)="addFaculty()"
            >
              <i class="pi pi-plus"></i>
              Add Faculty
            </button>
          </div>
          <div formArrayName="faculty">
            <div 
              *ngFor="let faculty of facultyArray.controls; let i = index"
              [formGroupName]="i"
              class="faculty-item"
            >
              <div class="item-header">
                <h5>Faculty Member {{ i + 1 }}</h5>
                <button 
                  type="button"
                  class="btn-remove"
                  (click)="removeFaculty(i)"
                >
                  <i class="pi pi-trash"></i>
                </button>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label>Name *</label>
                  <input type="text" class="form-control" formControlName="name">
                </div>
                <div class="form-group">
                  <label>Title</label>
                  <input type="text" class="form-control" formControlName="title">
                </div>
                <div class="form-group">
                  <label>Specialization</label>
                  <input type="text" class="form-control" formControlName="specialization">
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" class="form-control" formControlName="email">
                </div>
                <div class="form-group full-width">
                  <label>Faculty Photo *</label>
                  <div class="image-preview-section">
                    <div class="current-image-preview">
                      <img 
                        [src]="facultyArray.at(i).get('photo')?.value || 'https://via.placeholder.com/150'" 
                        alt="Faculty Photo" 
                        class="current-image"
                      >
                    </div>
                    <div class="image-selection-section">
                      <div class="upload-option">
                        <input type="file" #facultyPhotoInput (change)="onImageFileSelected($event, 'facultyPhoto', i)" 
                               accept="image/*" style="display: none;">
                        <button class="upload-btn" (click)="facultyPhotoInput.click()">
                          <i class="pi pi-upload"></i>
                          <span>Upload New Photo</span>
                        </button>
                      </div>
                      <div class="media-gallery-section">
                        <button class="btn btn-outline-primary" (click)="openImageModal('facultyPhoto', i)">
                          <i class="pi pi-image me-2"></i>
                          Choose from Media Gallery
                        </button>
                        <div class="media-grid-small" *ngIf="imageMediaItems.length > 0">
                          <div class="media-item-small" 
                               *ngFor="let item of imageMediaItems | slice:0:4"
                               [class.selected]="facultyArray.at(i).get('photo')?.value === item.url"
                               (click)="facultyArray.at(i).get('photo')?.setValue(item.url)">
                            <img [src]="item.url" [alt]="item.name" class="media-thumb">
                            <div class="selection-overlay" *ngIf="facultyArray.at(i).get('photo')?.value === item.url">
                              <i class="pi pi-check"></i>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" [class.active]="activeTab === 'activities'">
        <div class="activities-section">
          <div class="section-header">
            <h4>Department Activities</h4>
            <button 
              type="button"
              class="btn-add-item"
              (click)="addActivity()"
            >
              <i class="pi pi-plus"></i>
              Add Activity
            </button>
          </div>
          <div formArrayName="activities">
            <div 
              *ngFor="let activity of activitiesArray.controls; let i = index"
              [formGroupName]="i"
              class="activity-item"
            >
              <div class="item-header">
                <h5>Activity {{ i + 1 }}</h5>
                <button 
                  type="button"
                  class="btn-remove"
                  (click)="removeActivity(i)"
                >
                  <i class="pi pi-trash"></i>
                </button>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label>Title *</label>
                  <input type="text" class="form-control" formControlName="title">
                </div>
                <div class="form-group">
                  <label>Date</label>
                  <input type="date" class="form-control" formControlName="date">
                </div>
                <div class="form-group full-width">
                  <label>Description</label>
                  <textarea class="form-control" formControlName="description" rows="3"></textarea>
                </div>
                <div class="form-group full-width">
                  <label>Activity Image</label>
                  <div class="image-preview-section">
                    <div class="current-image-preview">
                      <img 
                        [src]="activitiesArray.at(i).get('image')?.value || 'https://via.placeholder.com/150'" 
                        alt="Activity Image" 
                        class="current-image"
                      >
                    </div>
                    <div class="image-selection-section">
                      <div class="upload-option">
                        <input type="file" #activityImageInput (change)="onImageFileSelected($event, 'activityImage', null, i)" 
                               accept="image/*" style="display: none;">
                        <button class="upload-btn" (click)="activityImageInput.click()">
                          <i class="pi pi-upload"></i>
                          <span>Upload New Image</span>
                        </button>
                      </div>
                      <div class="media-gallery-section">
                        <button class="btn btn-outline-primary" (click)="openImageModal('activityImage', null, i)">
                          <i class="pi pi-image me-2"></i>
                          Choose from Media Gallery
                        </button>
                        <div class="media-grid-small" *ngIf="imageMediaItems.length > 0">
                          <div class="media-item-small" 
                               *ngFor="let item of imageMediaItems | slice:0:4"
                               [class.selected]="activitiesArray.at(i).get('image')?.value === item.url"
                               (click)="activitiesArray.at(i).get('image')?.setValue(item.url)">
                            <img [src]="item.url" [alt]="item.name" class="media-thumb">
                            <div class="selection-overlay" *ngIf="activitiesArray.at(i).get('image')?.value === item.url">
                              <i class="pi pi-check"></i>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" [class.active]="activeTab === 'contact'">
        <div class="contact-section">
          <h4>Contact Information</h4>
          <div formGroupName="contact" class="form-grid">
            <div class="form-group">
              <label>Email</label>
              <input type="email" class="form-control" formControlName="email">
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" class="form-control" formControlName="phone">
            </div>
            <div class="form-group">
              <label>Office</label>
              <input type="text" class="form-control" formControlName="office">
            </div>
            <div class="form-group">
              <label>Head of Department</label>
              <input type="text" class="form-control" formControlName="headOfDepartment">
            </div>
          </div>
        </div>
      </div>

      <div class="dialog-actions">
        <button 
          type="button"
          class="btn-outline-primary-custom"
          [routerLink]="['/dashboard/departments']"
        >
          Cancel
        </button>
        <button 
          type="submit"
          class="btn-primary-custom"
          [disabled]="departmentForm.invalid"
        >
          Update Department
        </button>
      </div>
    </div>
  </form>

  <!-- Image Selection Modal -->
  <div class="modal-overlay" *ngIf="showImageModal" (click)="closeImageModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Select Image from Media Gallery</h3>
        <button class="close-btn" (click)="closeImageModal()">
          <i class="pi pi-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="upload-section">
          <input type="file" #modalFileInput (change)="onImageFileSelected($event, selectedField!)" 
                 accept="image/*" style="display: none;">
          <button class="btn btn-primary-gradient" (click)="modalFileInput.click()">
            <i class="pi pi-upload me-2"></i>
            Upload New Image
          </button>
        </div>
        <div class="modal-media-grid">
          <div class="modal-media-item" 
               *ngFor="let item of imageMediaItems"
               [class.selected]="selectedImageUrl === item.url"
               (click)="selectImageFromModal(item.url)">
            <img [src]="item.url" [alt]="item.name" class="modal-media-thumb">
            <div class="selection-overlay" *ngIf="selectedImageUrl === item.url">
              <i class="pi pi-check"></i>
            </div>
            <div class="media-name">{{ item.name }}</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" (click)="closeImageModal()">
          Cancel
        </button>
        <button class="btn btn-primary-gradient" 
                [disabled]="!selectedImageUrl"
                (click)="confirmImageSelection()">
          <i class="pi pi-check me-2"></i>
          Select Image
        </button>
      </div>
    </div>
  </div>

  <!-- Upload Progress -->
  <div class="upload-progress" *ngIf="isUploading">
    <div class="progress-card">
      <div class="progress-header">
        <h4>Uploading Image...</h4>
        <span>{{ uploadProgress }}%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="uploadProgress"></div>
      </div>
    </div>
  </div>

  <!-- Toast Messages -->
  <div class="toast-container" *ngIf="showToast">
    <div class="toast" [class]="toastClass">
      <div class="toast-content">
        <i [class]="toastIcon"></i>
        <span>{{ toastMessage }}</span>
      </div>
      <button type="button" class="toast-close" (click)="hideToast()">×</button>
    </div>
  </div>
</section>